#!/bin/bash

set -eu

# helm-manager can put its state into this project, not its own
export HELM_MGR_STATE_ROOT=state/helm

# helm-manager sets up TLS for tiller; so use `--tls` for all helm commands
export HELM_TLS_VERIFY=true

cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"

failfast() {
  [[ "$(command -v helm-manager)X" == "X" ]] && {
    echo "ERROR: missing 'helm-manager' CLI; fetch git submodules to get vendor/helm-tiller-manager/bin folder" >> $1
  }
}

up() {
  echo "Install/upgrade Tiller Server for Helm"
  helm-manager up
  helm repo update
  [[ "${CREDHUB_BASE_PATH:-X}" != "X" ]] && {
    echo "Storing helm into credhub ${CREDHUB_BASE_PATH}..."
    [[ -f $(helm home)/ca.pem ]] && {
      credhub set -n "${CREDHUB_BASE_PATH}/helm-ca" -t value -v "$(cat "$(helm home)/ca.pem")"
      credhub set -n "${CREDHUB_BASE_PATH}/helm-tiller-cert" -t value -v "$(cat "$(helm home)/cert.pem")"
      credhub set -n "${CREDHUB_BASE_PATH}/helm-tiller-key" -t value -v "$(cat "$(helm home)/key.pem")"
    }
  }
}

case "${1:-usage}" in
  failfast)
    shift
    failfast "$@"
    ;;

  up)
    shift
    up
    ;;

  *)
    ;;
esac
